
/**
 * Return the active companies
 */
const activityPlanTracking = (dateRange) => `
SELECT DISTINCT PLAN_ID as activityPlan
      ,COMPANY as company
  FROM [LEANKEEP].[DBO].[ACTIVITY_PLANS_TRACK_MONGO] TRACKING
 INNER JOIN [LEANKEEP].[DBO].EMPRESAS COMPANY
    ON COMPANY.EMPRESA = TRACKING.COMPANY
 WHERE TRACKING.LAST_DATE_CHANGED >= '${dateRange}'
   AND COMPANY.STATUS = 1
`

// /**
//  * Returns activty plan detail
//  */
// const activityPlanDetail = (activityPlan, company) => `
//  SELECT AM.NOME AS NOMEAUDITORIA,
//         AM.AUDITORIAMANUTENCAO,
//         (SELECT NOMEFANTASIA FROM EMPRESAS WITH(NOLOCK) WHERE EMPRESA = AM.EMPRESA) AS EMPRESA,
//         (SELECT NOME FROM SITES WITH (NOLOCK) WHERE SITE = AM.SITE) AS UNIDADE,
//         AM.DATAVISTORIA AS DATAVISTORIA,
//         (CASE
//             WHEN NOT AP.AREA IS NULL THEN (SELECT IDENTIFICACAOAMBIENTE + '/' +NOME AS AREANOME FROM AREAS WITH (NOLOCK) WHERE AREA = AP.AREA)
//             WHEN NOT AP.SITE IS NULL THEN (SELECT NOME AS SITENOME FROM SITES WITH (NOLOCK) WHERE SITE = AP.SITE)
//         END) AS APLICACAO,
//         (SELECT NOME FROM USUARIOS WITH(NOLOCK) WHERE USUARIO = AM.RESPONSAVEL) AS RESPONSAVEL,
//         PA.PLANOATIVIDADE,
//         PA.NOME AS CHECKLISTNOME,
//         TR.TAREFA AS TAREFAID,
//         (SELECT NOME FROM DBO.TIPOSATIVIDADE WITH(NOLOCK) WHERE TIPOATIVIDADE = AT.TIPOATIVIDADE ) AS TIPOATIVIDADE ,
//         TR.DESCRICAO AS TAREFADESCRICAO,
//         (SELECT IDENTIFICACAOAMBIENTE + '/' +NOME AS AREANOME FROM AREAS WITH (NOLOCK) WHERE AREA = AP.AREA) AS AREA,
//         (SELECT TAG + '/' + NOME AS EQUIPAMENTONOME FROM EQUIPAMENTOS WITH (NOLOCK) WHERE EQUIPAMENTO = AP.EQUIPAMENTO) AS EQUIPAMENTO,
//         (SELECT NOME FROM SISTEMASEMPRESAS WITH(NOLOCK) WHERE SISTEMAEMPRESA = AT.SISTEMAEMPRESA) AS SISTEMAEMPRESA,
//         TR.DATAREALIZADA,
//         TR.DATAPREVISTA,
//         TR.OBSERVACOES,
//         (CASE
//             WHEN AT.TIPOVALIDACAO = 1 THEN 'CONFORMIDADE'
//             WHEN AT.TIPOVALIDACAO = 2 THEN 'AVALIAÇÃO'
//             WHEN AT.TIPOVALIDACAO = 3 THEN 'TEXTO'
//           END
//         ) AS TIPOVALIDACAO,
//         COALESCE(CF.NOME,AV.NOME,TR.TEXTO) AS TIPOVALIDACAONOME,
//         ANL.CQA,
//         AM.COMENTARIOS AS COMENTARIODAAUDITORIA -- UM SO COMENTARIO POR PLANO
//   FROM AUDITORIASMANUTENCAO AM WITH(NOLOCK)
//  INNER JOIN PLANOSATIVIDADES PA WITH(NOLOCK) ON AM.AUDITORIAMANUTENCAO = PA.AUDITORIAMANUTENCAO
//  INNER JOIN APLICACOESPLANOATIVIDADE AP WITH(NOLOCK) ON PA.PLANOATIVIDADE = AP.PLANOATIVIDADE
//  INNER JOIN TAREFAS TR WITH(NOLOCK) ON TR.APLICACAOPLANOATIVIDADE = AP.APLICACAOPLANOATIVIDADE
//  INNER JOIN ATIVIDADES AT WITH(NOLOCK) ON TR.ATIVIDADE = AT.ATIVIDADE
//   LEFT JOIN ANOMALIAS ANL WITH(NOLOCK) ON TR.TAREFA = ANL.TAREFA
//   LEFT JOIN CONFORMIDADES CF WITH(NOLOCK) ON TR.CONFORMIDADE  = CF.CONFORMIDADE
//   LEFT JOIN AVALIACOES AV WITH(NOLOCK) ON TR.AVALIACAO  = AV.AVALIACAO
//  WHERE AM.EMPRESA = ${company}
//    AND PA.STATUS = 1 -- ATIVO
//    AND TR.REALIZADA = 1
//    AND AT.TIPOVALIDACAO IN (1,2,3) --CONFORMIDADES
//    AND PA.PLANOATIVIDADE = ${activityPlan}
//  ORDER BY AM.NOME,
//        AM.SITE,
//        COALESCE(AP.AREA,AP.SITE),
//        AT.SISTEMAEMPRESA
// `

// const activityPlanPictures = (activityPlan) => `
// SELECT TRF.TAREFA,FTR.FOTOPATH, FTR.OBSERVACAO
//   FROM FOTOSTAREFAS FTR WITH (NOLOCK)
//  INNER JOIN TAREFAS AS TRF WITH (NOLOCK) ON FTR.TAREFA = TRF.TAREFA
//  INNER JOIN APLICACOESPLANOATIVIDADE AS APL WITH (NOLOCK) ON TRF.APLICACAOPLANOATIVIDADE = APL.APLICACAOPLANOATIVIDADE
//  WHERE  APL.PLANOATIVIDADE = ${activityPlan}
//  GROUP BY FTR.FOTOPATH, FTR.OBSERVACAO,TRF.TAREFA
// `

const activityPlanFull = (company, activityPlan) => `

DECLARE @EMPRESA INT = ${company}
DECLARE @PLANO INT = ${activityPlan}

SELECT AM.NOME AS NOMEAUDITORIA,
AM.AUDITORIAMANUTENCAO,
(SELECT NOMEFANTASIA FROM EMPRESAS WITH(NOLOCK) WHERE EMPRESA = AM.EMPRESA) AS EMPRESA,
(SELECT NOME FROM SITES WITH (NOLOCK) WHERE SITE = AM.SITE) AS UNIDADE,
AM.DATAVISTORIA AS DATAVISTORIA,
(CASE
    WHEN NOT AP.AREA IS NULL THEN (SELECT IDENTIFICACAOAMBIENTE + '/' +NOME AS AREANOME FROM AREAS WITH (NOLOCK) WHERE AREA = AP.AREA)
    WHEN NOT AP.SITE IS NULL THEN (SELECT NOME AS SITENOME FROM SITES WITH (NOLOCK) WHERE SITE = AP.SITE)
  END) AS APLICACAO,
(SELECT NOME FROM USUARIOS WITH(NOLOCK) WHERE USUARIO = AM.RESPONSAVEL) AS RESPONSAVEL,
PA.PLANOATIVIDADE,
PA.NOME AS CHECKLISTNOME,
TR.TAREFA AS TAREFAID,
(SELECT NOME FROM DBO.TIPOSATIVIDADE WITH(NOLOCK) WHERE TIPOATIVIDADE = AT.TIPOATIVIDADE ) AS TIPOATIVIDADE ,
TR.DESCRICAO AS TAREFADESCRICAO,
(SELECT IDENTIFICACAOAMBIENTE + '/' +NOME AS AREANOME FROM AREAS WITH (NOLOCK) WHERE AREA = AP.AREA) AS AREA,
(SELECT TAG + '/' + NOME AS EQUIPAMENTONOME FROM EQUIPAMENTOS WITH (NOLOCK) WHERE EQUIPAMENTO = AP.EQUIPAMENTO) AS EQUIPAMENTO,
(SELECT NOME FROM SISTEMASEMPRESAS WITH(NOLOCK) WHERE SISTEMAEMPRESA = AT.SISTEMAEMPRESA) AS SISTEMAEMPRESA,
TR.DATAREALIZADA,
TR.DATAPREVISTA,
TR.OBSERVACOES,
(CASE
    WHEN AT.TIPOVALIDACAO = 1 THEN 'CONFORMIDADE'
    WHEN AT.TIPOVALIDACAO = 2 THEN 'AVALIAÇÃO'
    WHEN AT.TIPOVALIDACAO = 3 THEN 'TEXTO'
  END
) AS TIPOVALIDACAO,
COALESCE(CF.NOME,AV.NOME,TR.TEXTO) AS TIPOVALIDACAONOME,
ANL.CQA,
AM.COMENTARIOS AS COMENTARIODAAUDITORIA -- UM SO COMENTARIO POR PLANO
FROM    AUDITORIASMANUTENCAO AM WITH(NOLOCK)
INNER JOIN PLANOSATIVIDADES PA WITH(NOLOCK) ON AM.AUDITORIAMANUTENCAO = PA.AUDITORIAMANUTENCAO
INNER JOIN APLICACOESPLANOATIVIDADE AP WITH(NOLOCK) ON PA.PLANOATIVIDADE = AP.PLANOATIVIDADE
INNER JOIN TAREFAS TR WITH(NOLOCK) ON TR.APLICACAOPLANOATIVIDADE = AP.APLICACAOPLANOATIVIDADE
INNER JOIN ATIVIDADES AT WITH(NOLOCK) ON TR.ATIVIDADE = AT.ATIVIDADE
LEFT JOIN ANOMALIAS ANL WITH(NOLOCK) ON TR.TAREFA = ANL.TAREFA
LEFT JOIN CONFORMIDADES CF WITH(NOLOCK) ON TR.CONFORMIDADE  = CF.CONFORMIDADE
LEFT JOIN AVALIACOES AV WITH(NOLOCK) ON TR.AVALIACAO  = AV.AVALIACAO
WHERE  AM.EMPRESA = @EMPRESA
AND    PA.STATUS = 1 -- ATIVO
AND	   PA.PLANOATIVIDADE = @PLANO
AND    TR.REALIZADA = 1
AND    AT.TIPOVALIDACAO IN (1,2,3) --CONFORMIDADES
ORDER BY AM.NOME,
  AM.SITE,
  COALESCE(AP.AREA,AP.SITE),
  AT.SISTEMAEMPRESA
`

module.exports = {
  activityPlanTracking,
  // activityPlanDetail,
  // activityPlanPictures,
  activityPlanFull
}
